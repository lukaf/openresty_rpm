box: lukaf/rpmbuild

build:
  steps:
    - script:
      name: build rpm
      code: |
        # code is mounted ro inside the container
        mkdir -p /tmp/src
        rsync -auh /mnt/source/ /tmp/src/
        cd /tmp/src
        git submodule update --init --recursive
        git submodule foreach git pull origin master
        ./build.sh -b -v $VERSION

deploy:
  steps:
    - github-create-release:
      token: $GITHUB_TOKEN
      tag: $VERSION
      title: Openresty $VERSION
      draft: true
    - github-upload-asset:
      token: $GITHUB_TOKEN
      file: /tmp/src/rpmbuild/RPMS/x86_64/ngx_openresty-${VERSION}-1.x86_64.rpm
